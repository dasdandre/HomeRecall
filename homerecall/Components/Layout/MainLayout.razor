@inherits LayoutComponentBase
@implements IDisposable
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

@using Microsoft.Extensions.Localization
@using System.Text.Json.Serialization
@inject IStringLocalizer<SharedResource> L

<MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Color="Color.Default" Dense="true" Class="mud-appbar-fixed-top">
        <MudText Typo="Typo.h6" Class="ml-2 mr-4">@L["App_Title"]</MudText>

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudTabs Elevation="0" Rounded="true" Color="Color.Transparent" SliderColor="Color.Primary"
                ActivePanelIndex="@_activeTab" ActivePanelIndexChanged="OnTabChanged" Centered="true" Class="ml-4 ha-appbar-tabs">
                <MudTabPanel Text="@L["Nav_Devices"]" Icon="@Icons.Material.Filled.Home" />
                <MudTabPanel Text="@L["Nav_Settings"]" Icon="@Icons.Material.Filled.Settings" />
            </MudTabs>
        </MudHidden>

        <MudSpacer />
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="mt-8 mb-16"> <!-- mb-16 for bottom nav space -->
            @Body
        </MudContainer>
    </MudMainContent>

    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudPaper Elevation="3" Class="d-flex justify-space-around align-center py-2 fixed-bottom"
            Style="background-color: var(--mud-palette-background); position: fixed; bottom: 0; width: 100%; z-index: 1000;">
            <MudIconButton Icon="@Icons.Material.Filled.Home" Color="@(_activeTab == 0 ? Color.Primary : Color.Default)"
                OnClick="@(() => OnTabChanged(0))" />
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                Color="@(_activeTab == 1 ? Color.Primary : Color.Default)" OnClick="@(() => OnTabChanged(1))" />
        </MudPaper>
    </MudHidden>
</MudLayout>

@code {
    private MudTheme _theme = new MudTheme();
    private bool _isDarkMode = false;
    private MudThemeProvider _mudThemeProvider = null!;
    private int _activeTab = 0;

        protected override async Task OnInitializedAsync()
    {
        // Define standard HA Colors
        _theme.PaletteLight = new PaletteLight
        {
            Primary = "#03a9f4",
            Secondary = "#ff9800",
            AppbarBackground = "#fafafa",
            AppbarText = "#212121",
            Background = "#fafafa",
            Surface = "#ffffff",
            TextPrimary = "#212121",
            TextSecondary = "#727272",
            DrawerBackground = "#ffffff",
            DrawerText = "#212121"
        };

        _theme.PaletteDark = new PaletteDark
        {
            Primary = "#03a9f4",
            Secondary = "#ff9800",
            AppbarBackground = "#111111", // Match background
            AppbarText = "#e1e1e1",
            Background = "#111111",
            Surface = "#1e1e1e",
            TextPrimary = "#e1e1e1",
            TextSecondary = "#b0b0b0",
            DrawerBackground = "#1e1e1e",
            DrawerText = "#e1e1e1"
        };

        NavigationManager.LocationChanged += OnLocationChanged;
        UpdateActiveTab(NavigationManager.Uri);
        await Task.CompletedTask;
    }
    
            private DotNetObjectReference<MainLayout>? _objRef;
        
            protected override async Task OnAfterRenderAsync(bool firstRender)
            {
                if (firstRender)
                {
                    _objRef = DotNetObjectReference.Create(this);
                    
                    // Try to hook into HA theme
                    bool haConnected = false;
                    try
                    {
                        haConnected = await JS.InvokeAsync<bool>("window.observeHaThemeChange", _objRef);
                    }
                    catch
                    {
                        // Ignore if JS not available yet or other error
                    }
        
                    // Only fallback to system preference if NOT in HA (or HA sync failed)
                    if (!haConnected && _mudThemeProvider != null)
                    {
                        try
                        {
                            _isDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
                            await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
                            StateHasChanged();
                        }
                        catch(Exception)
                        {
                            // Ignore JS Interop errors if prerendering or disconnected
                        }
                    }
                }
            }
        
            [JSInvokable]
            public void UpdateThemeFromJs(HaThemeColors colors)
            {
                _isDarkMode = colors.IsDarkMode;
                
                var targetPalette = _isDarkMode ? (Palette)_theme.PaletteDark : (Palette)_theme.PaletteLight;
        
                if (colors.Primary != null) targetPalette.Primary = colors.Primary;
                if (colors.Secondary != null) targetPalette.Secondary = colors.Secondary;
                if (colors.Background != null) targetPalette.Background = colors.Background;
                if (colors.Surface != null) targetPalette.Surface = colors.Surface;
                if (colors.AppBarBackground != null) targetPalette.AppbarBackground = colors.AppBarBackground;
                if (colors.AppBarText != null) targetPalette.AppbarText = colors.AppBarText;
                if (colors.TextPrimary != null) targetPalette.TextPrimary = colors.TextPrimary;
                if (colors.TextSecondary != null) targetPalette.TextSecondary = colors.TextSecondary;
                if (colors.DrawerBackground != null) targetPalette.DrawerBackground = colors.DrawerBackground;
                if (colors.DrawerText != null) targetPalette.DrawerText = colors.DrawerText;
                if (colors.Success != null) targetPalette.Success = colors.Success;
                if (colors.Error != null) targetPalette.Error = colors.Error;
        
                StateHasChanged();
            }
        
            public class HaThemeColors
            {
                [JsonPropertyName("isDarkMode")]
                public bool IsDarkMode { get; set; }
                
                [JsonPropertyName("primary")]
                public string? Primary { get; set; }
                
                [JsonPropertyName("secondary")]
                public string? Secondary { get; set; }
                
                [JsonPropertyName("background")]
                public string? Background { get; set; }
                
                [JsonPropertyName("surface")]
                public string? Surface { get; set; }
                
                [JsonPropertyName("textPrimary")]
                public string? TextPrimary { get; set; }
                
                [JsonPropertyName("textSecondary")]
                public string? TextSecondary { get; set; }
                
                [JsonPropertyName("appBarBackground")]
                public string? AppBarBackground { get; set; }
                
                [JsonPropertyName("appBarText")]
                public string? AppBarText { get; set; }
                
                [JsonPropertyName("drawerBackground")]
                public string? DrawerBackground { get; set; }
                
                [JsonPropertyName("drawerText")]
                public string? DrawerText { get; set; }
        
                [JsonPropertyName("success")]
                public string? Success { get; set; }
        
                [JsonPropertyName("error")]
                public string? Error { get; set; }
            }
        
            private Task OnSystemPreferenceChanged(bool newValue)
    {
        _isDarkMode = newValue;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateActiveTab(e.Location);
        StateHasChanged();
    }

    private void UpdateActiveTab(string url)
    {
        if (url.Contains("/settings", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 1;
        }
        else if (url.EndsWith("/") || !url.Contains("/backups", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 0;
        }
        // If on backups page, keep current or default to devices (0)
        else if (url.Contains("/backups", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 0;
        }
    }

    private void OnTabChanged(int index)
    {
        _activeTab = index;
        if (index == 0) NavigationManager.NavigateTo("");
        else if (index == 1) NavigationManager.NavigateTo("settings");
    }

    public void Dispose()
    {
        _objRef?.Dispose();
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}