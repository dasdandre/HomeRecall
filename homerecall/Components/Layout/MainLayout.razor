@inherits LayoutComponentBase
@implements IDisposable
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> L

<MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Color="Color.Primary" Dense="true" Class="mud-appbar-fixed-top">
        <MudText Typo="Typo.h6" Class="ml-2 mr-4">@L["App_Title"]</MudText>

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" SliderColor="Color.Secondary"
                ActivePanelIndex="@_activeTab" ActivePanelIndexChanged="OnTabChanged" Centered="true" Class="ml-4">
                <MudTabPanel Text="@L["Nav_Devices"]" Icon="@Icons.Material.Filled.Home" />
                <MudTabPanel Text="@L["Nav_Settings"]" Icon="@Icons.Material.Filled.Settings" />
            </MudTabs>
        </MudHidden>

        <MudSpacer />
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="mt-8 mb-16"> <!-- mb-16 for bottom nav space -->
            @Body
        </MudContainer>
    </MudMainContent>

    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudPaper Elevation="3" Class="d-flex justify-space-around align-center py-2 fixed-bottom"
            Style="background-color: var(--mud-palette-background); position: fixed; bottom: 0; width: 100%; z-index: 1000;">
            <MudIconButton Icon="@Icons.Material.Filled.Home" Color="@(_activeTab == 0 ? Color.Primary : Color.Default)"
                OnClick="@(() => OnTabChanged(0))" />
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                Color="@(_activeTab == 1 ? Color.Primary : Color.Default)" OnClick="@(() => OnTabChanged(1))" />
        </MudPaper>
    </MudHidden>
</MudLayout>

@code {
    private MudTheme _theme = new MudTheme();
    private bool _isDarkMode = false;
    private MudThemeProvider _mudThemeProvider = null!;
    private int _activeTab = 0;

        protected override async Task OnInitializedAsync()
    {
        // Define standard HA Colors
        _theme.PaletteLight = new PaletteLight
        {
            Primary = "#03a9f4",
            Secondary = "#ff9800",
            AppbarBackground = "#03a9f4",
            AppbarText = "#ffffff",
            Background = "#fafafa",
            Surface = "#ffffff",
            TextPrimary = "#212121",
            TextSecondary = "#727272",
            DrawerBackground = "#ffffff",
            DrawerText = "#212121"
        };

        _theme.PaletteDark = new PaletteDark
        {
            Primary = "#03a9f4",
            Secondary = "#ff9800",
            AppbarBackground = "#101e24", // Slightly darker for dark mode
            AppbarText = "#ffffff",
            Background = "#111111",
            Surface = "#1e1e1e",
            TextPrimary = "#e1e1e1",
            TextSecondary = "#b0b0b0",
            DrawerBackground = "#1e1e1e",
            DrawerText = "#e1e1e1"
        };

        NavigationManager.LocationChanged += OnLocationChanged;
        UpdateActiveTab(NavigationManager.Uri);
        await Task.CompletedTask;
    }
    
            protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider != null)
        {
            try
            {
                _isDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
                await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
                StateHasChanged();
            }
            catch(Exception)
            {
                // Ignore JS Interop errors if prerendering or disconnected
            }
        }
    }

    private Task OnSystemPreferenceChanged(bool newValue)
    {
        _isDarkMode = newValue;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateActiveTab(e.Location);
        StateHasChanged();
    }

    private void UpdateActiveTab(string url)
    {
        if (url.Contains("/settings", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 1;
        }
        else if (url.EndsWith("/") || !url.Contains("/backups", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 0;
        }
        // If on backups page, keep current or default to devices (0)
        else if (url.Contains("/backups", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 0;
        }
    }

    private void OnTabChanged(int index)
    {
        _activeTab = index;
        if (index == 0) NavigationManager.NavigateTo("");
        else if (index == 1) NavigationManager.NavigateTo("settings");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}