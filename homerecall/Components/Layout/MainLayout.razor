@inherits LayoutComponentBase
@implements IDisposable
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> L

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
        <MudAppBar Elevation="0" Color="Color.Primary" Dense="true" Class="mud-appbar-fixed-top">
        <MudText Typo="Typo.h6" Class="ml-2 mr-4">@L["App_Title"]</MudText>
        
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" SliderColor="Color.Secondary" ActivePanelIndex="@_activeTab" ActivePanelIndexChanged="OnTabChanged" Centered="true" Class="ml-4">
                <MudTabPanel Text="@L["Nav_Devices"]" Icon="@Icons.Material.Filled.Home" />
                <MudTabPanel Text="@L["Nav_Settings"]" Icon="@Icons.Material.Filled.Settings" />
            </MudTabs>
        </MudHidden>
        
        <MudSpacer />
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-16"> <!-- mb-16 for bottom nav space -->
            @Body
        </MudContainer>
    </MudMainContent>
    
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudPaper Elevation="3" Class="d-flex justify-space-around align-center py-2 fixed-bottom" Style="background-color: var(--mud-palette-background); position: fixed; bottom: 0; width: 100%; z-index: 1000;">
            <MudIconButton Icon="@Icons.Material.Filled.Home" Color="@(_activeTab == 0 ? Color.Primary : Color.Default)" OnClick="@(() => OnTabChanged(0))" />
            <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="@(_activeTab == 1 ? Color.Primary : Color.Default)" OnClick="@(() => OnTabChanged(1))" />
        </MudPaper>
    </MudHidden>
</MudLayout>

@code {
        private MudTheme _theme = new MudTheme();
    private bool _isDarkMode = false;
    private DotNetObjectReference<MainLayout>? _objRef;
    private int _activeTab = 0;

    protected override void OnInitialized()
    {
        // Set Default HA Colors immediately to avoid flickering
        _theme.PaletteLight.Primary = "#03a9f4";
        _theme.PaletteLight.AppbarBackground = "#03a9f4";
        _theme.PaletteDark.Primary = "#03a9f4";
        _theme.PaletteDark.AppbarBackground = "#03a9f4";
        
        NavigationManager.LocationChanged += OnLocationChanged;
        UpdateActiveTab(NavigationManager.Uri);
    }
    
        private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateActiveTab(e.Location);
        StateHasChanged();
    }
    
    private void UpdateActiveTab(string url)
    {
        if (url.Contains("/settings", StringComparison.OrdinalIgnoreCase))
        {
            _activeTab = 1;
        }
        else if (url.EndsWith("/") || !url.Contains("/backups", StringComparison.OrdinalIgnoreCase)) 
        {
            _activeTab = 0;
        }
        // If on backups page, keep current or default to devices (0)
        else if (url.Contains("/backups", StringComparison.OrdinalIgnoreCase))
        {
             _activeTab = 0;
        }
    }
    
    private void OnTabChanged(int index)
    {
        _activeTab = index;
        if (index == 0) NavigationManager.NavigateTo("");
        else if (index == 1) NavigationManager.NavigateTo("settings");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                _objRef = DotNetObjectReference.Create(this);
                
                // Call JS immediately to get colors
                await ApplyHomeAssistantColors();
                
                // Then set up observer
                await JS.InvokeVoidAsync("observeHaThemeChange", _objRef);
            }
            catch (Exception) 
            {
                // JS Interop might fail if connection not ready, but usually fine in OnAfterRenderAsync
            }
        }
    }

        private async Task ApplyHomeAssistantColors()
    {
        try 
        {
            var colors = await JS.InvokeAsync<HaColors>("getHaColors");
            UpdateTheme(colors);
            StateHasChanged();
        }
        catch (Exception)
        {
            // Ignore errors during theme application
        }
    }

    [JSInvokable]
    public void UpdateThemeFromJs(HaColors colors)
    {
        UpdateTheme(colors);
        StateHasChanged();
    }

        private void UpdateTheme(HaColors colors)
    {
        _isDarkMode = colors.IsDarkMode;

        // Apply HA colors to both palettes - MudBlazor handles mode switching
        // We set both to the received colors because HA sends us the *current* active colors.
        // Whether it's dark or light in HA, that's the color set we want to use right now.
        
        var palette = new PaletteLight
        {
            Primary = colors.Primary,
            Secondary = colors.Secondary,
            AppbarBackground = colors.AppBarBackground,
            AppbarText = colors.AppBarText,
            Background = colors.Background,
            Surface = colors.Surface,
            TextPrimary = colors.TextPrimary,
            TextSecondary = colors.TextSecondary,
            DrawerBackground = colors.DrawerBackground,
            DrawerText = colors.DrawerText
        };

        // We apply the same colors to both palettes so that whichever mode MudBlazor is in,
        // it matches what HA is currently showing.
        _theme.PaletteLight = palette;
        
        _theme.PaletteDark = new PaletteDark
        {
            Primary = colors.Primary,
            Secondary = colors.Secondary,
            AppbarBackground = colors.AppBarBackground,
            AppbarText = colors.AppBarText,
            Background = colors.Background,
            Surface = colors.Surface,
            TextPrimary = colors.TextPrimary,
            TextSecondary = colors.TextSecondary,
            DrawerBackground = colors.DrawerBackground,
            DrawerText = colors.DrawerText
        };
    }

        public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        _objRef?.Dispose();
    }

    public class HaColors
    {
        public bool IsDarkMode { get; set; } = false;
        public string Primary { get; set; } = "#03a9f4";
        public string Secondary { get; set; } = "#ff9800";
        public string Background { get; set; } = "#fafafa";
        public string Surface { get; set; } = "#ffffff";
        public string TextPrimary { get; set; } = "#212121";
        public string TextSecondary { get; set; } = "#727272";
        public string AppBarBackground { get; set; } = "#03a9f4";
        public string AppBarText { get; set; } = "#ffffff";
        public string DrawerBackground { get; set; } = "#ffffff";
        public string DrawerText { get; set; } = "#212121";
    }
}