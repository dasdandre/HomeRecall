@inherits LayoutComponentBase
@implements IDisposable
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Color="Color.Primary" Dense="true">
        <MudText Typo="Typo.h6" Class="ml-2">HomeRecall</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="@(() => NavigationManager.NavigateTo(""))" StartIcon="@Icons.Material.Filled.Home">Ger√§te</MudButton>
        <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="@(() => NavigationManager.NavigateTo("settings"))" StartIcon="@Icons.Material.Filled.Settings">Einstellungen</MudButton>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private MudTheme _theme = new MudTheme();
    private bool _isDarkMode = false;
    private DotNetObjectReference<MainLayout>? _objRef;

    protected override void OnInitialized()
    {
        // Set Default HA Colors immediately to avoid flickering
        _theme.PaletteLight.Primary = "#03a9f4";
        _theme.PaletteLight.AppbarBackground = "#03a9f4";
        _theme.PaletteDark.Primary = "#03a9f4";
        _theme.PaletteDark.AppbarBackground = "#03a9f4";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                _objRef = DotNetObjectReference.Create(this);
                
                // Call JS immediately to get colors
                await ApplyHomeAssistantColors();
                
                // Then set up observer
                await JS.InvokeVoidAsync("observeHaThemeChange", _objRef);
            }
            catch (Exception) 
            {
                // JS Interop might fail if connection not ready, but usually fine in OnAfterRenderAsync
            }
        }
    }

        private async Task ApplyHomeAssistantColors()
    {
        try 
        {
            var colors = await JS.InvokeAsync<HaColors>("getHaColors");
            UpdateTheme(colors);
            StateHasChanged();
        }
        catch (Exception)
        {
            // Ignore errors during theme application
        }
    }

    [JSInvokable]
    public void UpdateThemeFromJs(HaColors colors)
    {
        UpdateTheme(colors);
        StateHasChanged();
    }

        private void UpdateTheme(HaColors colors)
    {
        _isDarkMode = colors.IsDarkMode;

        // Apply HA colors to both palettes - MudBlazor handles mode switching
        // We set both to the received colors because HA sends us the *current* active colors.
        // Whether it's dark or light in HA, that's the color set we want to use right now.
        
        var palette = new PaletteLight
        {
            Primary = colors.Primary,
            Secondary = colors.Secondary,
            AppbarBackground = colors.AppBarBackground,
            AppbarText = colors.AppBarText,
            Background = colors.Background,
            Surface = colors.Surface,
            TextPrimary = colors.TextPrimary,
            TextSecondary = colors.TextSecondary,
            DrawerBackground = colors.DrawerBackground,
            DrawerText = colors.DrawerText
        };

        // We apply the same colors to both palettes so that whichever mode MudBlazor is in,
        // it matches what HA is currently showing.
        _theme.PaletteLight = palette;
        
        _theme.PaletteDark = new PaletteDark
        {
            Primary = colors.Primary,
            Secondary = colors.Secondary,
            AppbarBackground = colors.AppBarBackground,
            AppbarText = colors.AppBarText,
            Background = colors.Background,
            Surface = colors.Surface,
            TextPrimary = colors.TextPrimary,
            TextSecondary = colors.TextSecondary,
            DrawerBackground = colors.DrawerBackground,
            DrawerText = colors.DrawerText
        };
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }

    public class HaColors
    {
        public bool IsDarkMode { get; set; } = false;
        public string Primary { get; set; } = "#03a9f4";
        public string Secondary { get; set; } = "#ff9800";
        public string Background { get; set; } = "#fafafa";
        public string Surface { get; set; } = "#ffffff";
        public string TextPrimary { get; set; } = "#212121";
        public string TextSecondary { get; set; } = "#727272";
        public string AppBarBackground { get; set; } = "#03a9f4";
        public string AppBarText { get; set; } = "#ffffff";
        public string DrawerBackground { get; set; } = "#ffffff";
        public string DrawerText { get; set; } = "#212121";
    }
}