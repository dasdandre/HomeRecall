<MudDialog>
    <DialogContent>
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudText Class="mb-4">@L["Scan_Intro"]</MudText>
            
            <MudForm @bind-IsValid="@_isValid">
                <div class="d-flex gap-4">
                    <MudTextField @bind-Value="@_startIp" 
                                  Label="@L["Scan_StartIp"]" 
                                  Required="true"
                                  Validation="@(new Func<string, string?>(ValidateStartIp))"
                                  Placeholder="192.168.1.1" 
                                  Variant="Variant.Outlined" 
                                  Class="flex-grow-1"/>
                                  
                    <MudNumericField @bind-Value="@_endSuffix" 
                                     Label="@L["Scan_EndSuffix"]" 
                                     Variant="Variant.Outlined" 
                                     Min="1" Max="254" 
                                     Style="width: 100px;" />
                </div>
                <MudText Typo="Typo.caption" Class="ml-1">@L["Scan_Range_Preview"]: @_startIp - @GetEndIp()</MudText>

                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">@L["Scan_DeviceTypes"]</MudText>
                
                <MudChipSet T="DeviceType" AllClosable="false" SelectedValues="_selectedTypes" SelectedValuesChanged="OnSelectedValuesChanged" SelectionMode="SelectionMode.MultiSelection" CheckMark="true">
                    @foreach (var type in _allTypes)
                    {
                        <MudChip Value="@type" Text="@type.ToString()" Color="Color.Primary" Variant="Variant.Outlined" SelectedColor="Color.Primary" />
                    }
                </MudChipSet>
            </MudForm>
        }
        else
        {
            if (_scanRunning)
            {
                <div class="d-flex flex-column align-center justify-center py-4">
                    <MudText>@L["Scan_Running"] (@_progressPercent%)</MudText>
                    <MudProgressLinear Color="Color.Primary" Value="@_progressPercent" Class="my-2" />
                    <MudText Typo="Typo.caption" Class="mb-2">@L["Scan_Summary", _plannedScanCount, _skippedCount]</MudText>
                    <div class="d-flex gap-4 align-center">
                         <MudText Typo="Typo.caption">Scanning @_startIp - @GetEndIp()...</MudText>
                         <MudButton OnClick="StopScan" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small">Stop</MudButton>
                    </div>
                </div>
            }

            if (_foundDevices != null)
            {
                @if (!_foundDevices.Any() && !_scanRunning)
                {
                    <MudAlert Severity="Severity.Info" Class="my-4">@L["Scan_NoDevicesFound"]</MudAlert>
                    <MudButton OnClick="Reset" Variant="Variant.Text" Color="Color.Primary">@L["Common_Retry"]</MudButton>
                }
                else if (_foundDevices.Any())
                {
                    <MudText Typo="Typo.h6" Class="mb-2">@L["Scan_Results_Title"] (@_foundDevices.Count)</MudText>
                    <MudTable Items="@_foundDevices" MultiSelection="true" @bind-SelectedItems="_selectedItems" Hover="true" Dense="true" Elevation="0" Height="400px" FixedHeader="true">
                        <HeaderContent>
                            <MudTh>IP</MudTh>
                            <MudTh>Name</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Firmware</MudTh>
                            <MudTh>Model</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="IP">
                                <MudLink Href="@($"http://{context.Interfaces.FirstOrDefault()?.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.Interfaces.FirstOrDefault()?.IpAddress</MudLink>
                            </MudTd>
                            <MudTd DataLabel="Name">
                                 <MudTextField @bind-Value="context.Name" Margin="Margin.Dense" />
                            </MudTd>
                            <MudTd DataLabel="Type">@context.Type</MudTd>
                            <MudTd DataLabel="Firmware">@context.FirmwareVersion</MudTd>
                            <MudTd DataLabel="Model">@context.HardwareModel</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["Common_Cancel"]</MudButton>
        
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartScan" Disabled="@(!_isValid)">@L["Scan_Start"]</MudButton>
        }
        else if (_foundDevices != null && _foundDevices.Any())
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddSelected" Disabled="@(!_selectedItems.Any())">@L["Scan_AddSelected"] (@_selectedItems.Count)</MudButton>
        }
    </DialogActions>
</MudDialog>