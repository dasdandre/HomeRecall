@using HomeRecall
@using HomeRecall.Services
@using Microsoft.Extensions.Localization
@using Microsoft.EntityFrameworkCore
@inject IStringLocalizer<SharedResource> L
@inject IDeviceScanner Scanner
@inject BackupContext Context
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudText Class="mb-4">@L["Scan_Intro"]</MudText>
            
            <MudForm @bind-IsValid="@_isValid">
                <div class="d-flex gap-4">
                    <MudTextField @bind-Value="@_startIp" 
                                  Label="@L["Scan_StartIp"]" 
                                  Required="true"
                                  Validation="@(new Func<string, string?>(ValidateStartIp))"
                                  Placeholder="192.168.1.1" 
                                  Variant="Variant.Outlined" 
                                  Class="flex-grow-1"/>
                                  
                    <MudNumericField @bind-Value="@_endSuffix" 
                                     Label="@L["Scan_EndSuffix"]" 
                                     Variant="Variant.Outlined" 
                                     Min="1" Max="254" 
                                     Style="width: 100px;" />
                </div>
                <MudText Typo="Typo.caption" Class="ml-1">@L["Scan_Range_Preview"]: @_startIp - @GetEndIp()</MudText>

                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">@L["Scan_DeviceTypes"]</MudText>
                
                <MudGrid>
                    @foreach (var type in _allTypes)
                    {
                        <MudItem xs="6" sm="4">
                            <MudCheckBox T="bool" 
                                         Value="@(_selectedTypes.Contains(type))" 
                                         ValueChanged="@((bool v) => ToggleType(type, v))"
                                         Label="@type.ToString()" 
                                         Dense="true" 
                                         Color="Color.Primary"/>
                        </MudItem>
                    }
                </MudGrid>
            </MudForm>
        }
        else if (_scanRunning)
        {
            <div class="d-flex flex-column align-center justify-center py-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Value="@_progressPercent" Max="100" Class="mb-4" />
                <MudText>@L["Scan_Running"] (@_progressPercent%)</MudText>
                <MudText Typo="Typo.caption">Scanning @_startIp - @GetEndIp()...</MudText>
            </div>
        }
        else if (_foundDevices != null)
        {
            @if (!_foundDevices.Any())
            {
                <MudAlert Severity="Severity.Info" Class="my-4">@L["Scan_NoDevicesFound"]</MudAlert>
                <MudButton OnClick="Reset" Variant="Variant.Text" Color="Color.Primary">@L["Common_Retry"]</MudButton>
            }
            else
            {
                <MudText Typo="Typo.h6" Class="mb-2">@L["Scan_Results_Title"] (@_foundDevices.Count)</MudText>
                <MudTable Items="@_foundDevices" MultiSelection="true" @bind-SelectedItems="_selectedItems" Hover="true" Dense="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>IP</MudTh>
                        <MudTh>Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Firmware</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="IP">@context.IpAddress</MudTd>
                        <MudTd DataLabel="Name">
                             <MudTextField @bind-Value="context.Name" Margin="Margin.Dense" />
                        </MudTd>
                        <MudTd DataLabel="Type">@context.Type</MudTd>
                        <MudTd DataLabel="Firmware">@context.FirmwareVersion</MudTd>
                    </RowTemplate>
                </MudTable>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["Common_Cancel"]</MudButton>
        
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartScan" Disabled="@(!_isValid)">@L["Scan_Start"]</MudButton>
        }
        else if (_foundDevices != null && _foundDevices.Any())
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddSelected" Disabled="@(!_selectedItems.Any())">@L["Scan_AddSelected"] (@_selectedItems.Count)</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    private string _startIp = "192.168.1.1";
    private int _endSuffix = 254;
    private bool _isValid;
    private bool _scanRunning = false;
    private int _progressPercent = 0;
    
    private List<DeviceType> _allTypes = Enum.GetValues(typeof(DeviceType)).Cast<DeviceType>().ToList();
    private HashSet<DeviceType> _selectedTypes = new(Enum.GetValues(typeof(DeviceType)).Cast<DeviceType>());
    
    private List<DiscoveredDevice>? _foundDevices;
    private HashSet<DiscoveredDevice> _selectedItems = new();

    private string? ValidateStartIp(string ip)
    {
        if (string.IsNullOrWhiteSpace(ip)) return "Required";
        if (!System.Net.IPAddress.TryParse(ip, out _)) return "Invalid IP";
        
        var parts = ip.Split('.');
        if (parts.Length == 4 && int.TryParse(parts[3], out int startSuffix))
        {
             if (startSuffix > _endSuffix) return "Start > End";
        }
        
        return null;
    }

    private string GetEndIp()
    {
        if (string.IsNullOrWhiteSpace(_startIp)) return "";
        var parts = _startIp.Split('.');
        if (parts.Length != 4) return "";
        return $"{parts[0]}.{parts[1]}.{parts[2]}.{_endSuffix}";
    }

    private void ToggleType(DeviceType type, bool isChecked)
    {
        if (isChecked) _selectedTypes.Add(type);
        else _selectedTypes.Remove(type);
    }

    private void Reset()
    {
        _foundDevices = null;
        _scanRunning = false;
    }

    private async Task StartScan()
    {
        if (!_selectedTypes.Any())
        {
            Snackbar.Add("Select at least one device type", Severity.Warning);
            return;
        }

        _scanRunning = true;
        _progressPercent = 0;
        StateHasChanged();
        await Task.Delay(50); 

        var progressHandler = new Progress<int>(percent =>
        {
            _progressPercent = percent;
            StateHasChanged();
        });

        try
        {
            string endIp = GetEndIp();
            
            var results = await Scanner.ScanNetworkAsync(_startIp, endIp, _selectedTypes.ToList(), progressHandler);
            
            var knownIps = await Context.Devices.Select(d => d.IpAddress).ToListAsync();
            _foundDevices = results.Where(d => !knownIps.Contains(d.IpAddress)).ToList();
            
            _selectedItems = new HashSet<DiscoveredDevice>(_foundDevices);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Scan failed: {ex.Message}", Severity.Error);
            _foundDevices = new List<DiscoveredDevice>();
        }
        finally
        {
            _scanRunning = false;
        }
    }

    private async Task AddSelected()
    {
        int addedCount = 0;
        foreach (var d in _selectedItems)
        {
            if (!Context.Devices.Any(x => x.IpAddress == d.IpAddress))
            {
                Context.Devices.Add(new Device 
                { 
                    Name = d.Name, 
                    IpAddress = d.IpAddress, 
                    Type = d.Type,
                    CurrentFirmwareVersion = d.FirmwareVersion
                });
                addedCount++;
            }
        }
        
        await Context.SaveChangesAsync();
        Snackbar.Add($"{addedCount} devices added", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel();
}