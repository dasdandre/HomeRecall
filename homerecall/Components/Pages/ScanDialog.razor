@using HomeRecall
@using HomeRecall.Services
@using Microsoft.Extensions.Localization
@using Microsoft.EntityFrameworkCore
@inject IStringLocalizer<SharedResource> L
@inject IDeviceScanner Scanner
@inject BackupContext Context
@inject ISnackbar Snackbar
@implements IDisposable

<MudDialog>
    <DialogContent>
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudText Class="mb-4">@L["Scan_Intro"]</MudText>
            
            <MudForm @bind-IsValid="@_isValid">
                <div class="d-flex gap-4">
                    <MudTextField @bind-Value="@_startIp" 
                                  Label="@L["Scan_StartIp"]" 
                                  Required="true"
                                  Validation="@(new Func<string, string?>(ValidateStartIp))"
                                  Placeholder="192.168.1.1" 
                                  Variant="Variant.Outlined" 
                                  Class="flex-grow-1"/>
                                  
                    <MudNumericField @bind-Value="@_endSuffix" 
                                     Label="@L["Scan_EndSuffix"]" 
                                     Variant="Variant.Outlined" 
                                     Min="1" Max="254" 
                                     Style="width: 100px;" />
                </div>
                <MudText Typo="Typo.caption" Class="ml-1">@L["Scan_Range_Preview"]: @_startIp - @GetEndIp()</MudText>

                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">@L["Scan_DeviceTypes"]</MudText>
                
                <MudChipSet T="DeviceType" AllClosable="false" SelectedValues="_selectedTypes" SelectedValuesChanged="OnSelectedValuesChanged" SelectionMode="SelectionMode.MultiSelection" CheckMark="true">
                    @foreach (var type in _allTypes)
                    {
                        <MudChip Value="@type" Text="@type.ToString()" Color="Color.Primary" Variant="Variant.Outlined" SelectedColor="Color.Primary" />
                    }
                </MudChipSet>
            </MudForm>
        }
        else
        {
            if (_scanRunning)
            {
                <div class="d-flex flex-column align-center justify-center py-4">
                    <MudText>@L["Scan_Running"] (@_progressPercent%)</MudText>
                    <MudProgressLinear Color="Color.Primary" Value="@_progressPercent" Class="my-2" />
                    <MudText Typo="Typo.caption" Class="mb-2">@L["Scan_Summary", _plannedScanCount, _skippedCount]</MudText>
                    <div class="d-flex gap-4 align-center">
                         <MudText Typo="Typo.caption">Scanning @_startIp - @GetEndIp()...</MudText>
                         <MudButton OnClick="StopScan" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small">Stop</MudButton>
                    </div>
                </div>
            }

            if (_foundDevices != null)
            {
                @if (!_foundDevices.Any() && !_scanRunning)
                {
                    <MudAlert Severity="Severity.Info" Class="my-4">@L["Scan_NoDevicesFound"]</MudAlert>
                    <MudButton OnClick="Reset" Variant="Variant.Text" Color="Color.Primary">@L["Common_Retry"]</MudButton>
                }
                else if (_foundDevices.Any())
                {
                    <MudText Typo="Typo.h6" Class="mb-2">@L["Scan_Results_Title"] (@_foundDevices.Count)</MudText>
                    <MudTable Items="@_foundDevices" MultiSelection="true" @bind-SelectedItems="_selectedItems" Hover="true" Dense="true" Elevation="0" Height="400px" FixedHeader="true">
                        <HeaderContent>
                            <MudTh>IP</MudTh>
                            <MudTh>Name</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Firmware</MudTh>
                            <MudTh>Model</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="IP">
                                <MudLink Href="@($"http://{context.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.IpAddress</MudLink>
                            </MudTd>
                            <MudTd DataLabel="Name">
                                 <MudTextField @bind-Value="context.Name" Margin="Margin.Dense" />
                            </MudTd>
                            <MudTd DataLabel="Type">@context.Type</MudTd>
                            <MudTd DataLabel="Firmware">@context.FirmwareVersion</MudTd>
                            <MudTd DataLabel="Model">@context.HardwareModel</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["Common_Cancel"]</MudButton>
        
        @if (!_scanRunning && _foundDevices == null)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="StartScan" Disabled="@(!_isValid)">@L["Scan_Start"]</MudButton>
        }
        else if (_foundDevices != null && _foundDevices.Any())
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddSelected" Disabled="@(!_selectedItems.Any())">@L["Scan_AddSelected"] (@_selectedItems.Count)</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    private string _startIp = "192.168.1.1";
    private int _endSuffix = 254;
    private bool _isValid;
    private bool _scanRunning = false;
    private int _progressPercent = 0;
    private int _foundCount = 0;
    private int _plannedScanCount = 0;
    private int _skippedCount = 0;
    
    private List<DeviceType> _allTypes = Enum.GetValues(typeof(DeviceType)).Cast<DeviceType>().ToList();
    private List<DeviceType> _selectedTypes = Enum.GetValues(typeof(DeviceType)).Cast<DeviceType>().ToList();
    
    private List<DiscoveredDevice>? _foundDevices;
    private HashSet<DiscoveredDevice> _selectedItems = new();
    private CancellationTokenSource? _cts;

    // Try to detect local IP on init or load from settings
    protected override async Task OnInitializedAsync()
    {
        var settings = await Context.Settings.FindAsync(1);
        if (settings != null)
        {
            if (!string.IsNullOrEmpty(settings.LastScanIpStart))
            {
                _startIp = settings.LastScanIpStart;
                _endSuffix = settings.LastScanIpEndSuffix;
            }
            
            if (!string.IsNullOrEmpty(settings.LastScanDeviceTypes))
            {
                try 
                {
                    var types = settings.LastScanDeviceTypes.Split(',')
                        .Select(t => Enum.Parse<DeviceType>(t))
                        .ToList();
                    if (types.Any()) _selectedTypes = types;
                }
                catch { /* Ignore parsing errors */ }
            }
        }
    }

    private string? ValidateStartIp(string ip)
    {
        if (string.IsNullOrWhiteSpace(ip)) return "Required";
        if (!System.Net.IPAddress.TryParse(ip, out _)) return "Invalid IP";
        
        var parts = ip.Split('.');
        if (parts.Length == 4 && int.TryParse(parts[3], out int startSuffix))
        {
             if (startSuffix > _endSuffix) return "Start > End";
        }
        
        return null;
    }

    private string GetEndIp()
    {
        if (string.IsNullOrWhiteSpace(_startIp)) return "";
        var parts = _startIp.Split('.');
        if (parts.Length != 4) return "";
        return $"{parts[0]}.{parts[1]}.{parts[2]}.{_endSuffix}";
    }

    private void Reset()
    {
        _foundDevices = null;
        _scanRunning = false;
        _cts?.Cancel();
    }

    private async Task StartScan()
    {
        if (!_selectedTypes.Any())
        {
            Snackbar.Add("Select at least one device type", Severity.Warning);
            return;
        }

        _scanRunning = true;
        _foundDevices = new List<DiscoveredDevice>();
        _cts = new CancellationTokenSource();
        
        // Save settings for next time
        var settings = await Context.Settings.FindAsync(1);
        if (settings != null)
        {
            settings.LastScanIpStart = _startIp;
            settings.LastScanIpEndSuffix = _endSuffix;
            settings.LastScanDeviceTypes = string.Join(",", _selectedTypes);
            await Context.SaveChangesAsync();
        }

        _progressPercent = 0;
        _foundCount = 0;
        StateHasChanged();

        var progressHandler = new Progress<ScanProgressReport>(report =>
        {
            _progressPercent = report.Percent;
            _foundCount = report.FoundCount;
            if (report.LatestDevice != null)
            {
                if (_foundDevices != null && !_foundDevices.Any(d => d.IpAddress == report.LatestDevice.IpAddress))
                {
                    _foundDevices.Add(report.LatestDevice);
                    _selectedItems.Add(report.LatestDevice); // Auto-select new items
                }
            }
            StateHasChanged();
        });

        try
        {
            string endIp = GetEndIp();

            var knownIps = await Context.Devices.Select(d => d.IpAddress).ToListAsync();

            var (planned, skipped) = CalculatePlannedAndSkippedCount(_startIp, endIp, knownIps);
            _plannedScanCount = planned;
            _skippedCount = skipped;

            // Pass Cancellation Token
            var results = await Scanner.ScanNetworkAsync(_startIp, endIp, _selectedTypes.ToList(), progressHandler, knownIps, _cts.Token);
            
            // Final consistency check (optional, but good practice)
            if (results != null)
            {
                 // Merge just in case
                 foreach(var r in results)
                 {
                     if (!_foundDevices.Any(d => d.IpAddress == r.IpAddress))
                        _foundDevices.Add(r);
                 }
            }
        }
        catch (OperationCanceledException)
        {
            // Expected on cancel
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Scan failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _scanRunning = false;
            _cts?.Dispose();
            _cts = null;
        }
    }

    private void StopScan()
    {
        _cts?.Cancel();
    }


    private Task OnSelectedValuesChanged(IEnumerable<DeviceType> values)
    {
        _selectedTypes = values?.ToList() ?? new List<DeviceType>();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private (int planned, int skipped) CalculatePlannedAndSkippedCount(string startIp, string endIp, IEnumerable<string>? knownIps)
    {
        if (!System.Net.IPAddress.TryParse(startIp, out var ipStart) || !System.Net.IPAddress.TryParse(endIp, out var ipEnd))
            return (0, 0);

        byte[] startBytes = ipStart.GetAddressBytes();
        byte[] endBytes = ipEnd.GetAddressBytes();
        if (BitConverter.IsLittleEndian)
        {
            Array.Reverse(startBytes);
            Array.Reverse(endBytes);
        }

        uint startVal = BitConverter.ToUInt32(startBytes, 0);
        uint endVal = BitConverter.ToUInt32(endBytes, 0);
        if (endVal < startVal) return (0, 0);

        // Safety cap used in scanner: limit range to 513 addresses
        if (endVal - startVal > 512) endVal = startVal + 512;

        int total = (int)(endVal - startVal + 1);
        int skipped = 0;
        if (knownIps != null)
        {
            var knownSet = new HashSet<string>(knownIps);
            for (uint i = startVal; i <= endVal; i++)
            {
                byte[] bytes = BitConverter.GetBytes(i);
                if (BitConverter.IsLittleEndian) Array.Reverse(bytes);
                var ip = new System.Net.IPAddress(bytes).ToString();
                if (knownSet.Contains(ip)) skipped++;
            }
        }

        return (total - skipped, skipped);
    }

    private async Task AddSelected()
    {
        // Stop the scan first if running
        StopScan();

        int addedCount = 0;
        foreach (var d in _selectedItems)
        {
            if (!Context.Devices.Any(x => x.IpAddress == d.IpAddress))
            {
                Context.Devices.Add(new Device 
                { 
                    Name = d.Name, 
                    IpAddress = d.IpAddress, 
                    Type = d.Type,
                    MacAddress = d.MacAddress,
                    Hostname = d.Hostname,
                    CurrentFirmwareVersion = d.FirmwareVersion,
                    HardwareModel = d.HardwareModel
                });
                addedCount++;
            }
        }
        
        await Context.SaveChangesAsync();
        Snackbar.Add($"{addedCount} devices added", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() 
    {
        StopScan();
        MudDialog.Cancel();
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}