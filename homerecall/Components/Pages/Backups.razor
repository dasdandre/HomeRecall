@page "/backups/{DeviceId:int}"
@using HomeRecall
@using HomeRecall.Services
@using Microsoft.EntityFrameworkCore
@inject BackupContext Context
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudText Typo="Typo.h4" Class="mb-4">Backups for @(_device?.Name ?? "Loading...")</MudText>
<MudBreadcrumbs Items="_breadcrumbs"></MudBreadcrumbs>

@if (_device == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudTable Items="@_device.Backups.OrderByDescending(b => b.CreatedAt)" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Checksum (SHA1)</MudTh>
            <MudTh>Note</MudTh>
            <MudTh>Locked</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Date">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
            <MudTd DataLabel="Checksum">
                <MudTooltip Text="@context.Sha1Checksum">
                    @context.Sha1Checksum.Substring(0, Math.Min(8, context.Sha1Checksum.Length))...
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="Note">
                 <MudTextField Value="@context.Note" ValueChanged="@((string s) => UpdateNote(context, s))" Placeholder="Add note..." Margin="Margin.Dense" />
            </MudTd>
            <MudTd DataLabel="Locked">
                <MudCheckBox Value="@context.IsLocked" ValueChanged="@((bool b) => ToggleLock(context))" Color="Color.Warning"></MudCheckBox>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Download" Color="Color.Primary" OnClick="@(() => DownloadBackup(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteBackup(context))" Disabled="@context.IsLocked" />
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    [Parameter]
    public int DeviceId { get; set; }

    private Device? _device;
    private bool _loading = true;
    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Devices", href: NavigationManager.BaseUri),
            new BreadcrumbItem("Backups", href: null, disabled: true)
        };
    }

    private async Task LoadData()
    {
        _loading = true;
        _device = await Context.Devices
            .Include(d => d.Backups)
            .FirstOrDefaultAsync(d => d.Id == DeviceId);
        _loading = false;
    }

    private async Task ToggleLock(Backup backup)
    {
        backup.IsLocked = !backup.IsLocked;
        await Context.SaveChangesAsync();
    }

    private async Task UpdateNote(Backup backup, string note)
    {
        backup.Note = note;
        await Context.SaveChangesAsync();
    }

    private async Task DeleteBackup(Backup backup)
    {
        if (backup.IsLocked) return;

        bool? result = await DialogService.ShowMessageBox(
            "Delete Backup", 
            "Are you sure you want to delete this backup?", 
            yesText:"Delete", cancelText:"Cancel");

        if (result == true)
        {
            // Check if file is used by others
            var otherBackupsUsingFile = await Context.Backups
                .AnyAsync(b => b.StoragePath == backup.StoragePath && b.Id != backup.Id);

            if (!otherBackupsUsingFile)
            {
                var backupDirectory = Environment.GetEnvironmentVariable("backup_path") ?? Path.Combine(Directory.GetCurrentDirectory(), "backups");
                var path = Path.Combine(backupDirectory, backup.StoragePath);
                if (File.Exists(path))
                {
                    File.Delete(path);
                }
            }

            Context.Backups.Remove(backup);
            await Context.SaveChangesAsync();
            await LoadData();
            Snackbar.Add("Backup deleted", Severity.Success);
        }
    }

    private void DownloadBackup(Backup backup)
    {
        // For MudBlazor, we can redirect to a controller endpoint that serves the file
        // Or inject IJSRuntime to trigger download, but Controller is easier for file serving.
        // We will keep the Controller for file download for now.
        NavigationManager.NavigateTo($"/api/DownloadBackup/{backup.Id}", true);
    }
}