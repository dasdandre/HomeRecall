@page "/"
@using Humanizer
@using HomeRecall.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> L
@inject BackupContext Context
@inject IBackupService BackupService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">@L["Devices_Title"]</MudText>
        <MudStack Row="true" Spacing="2">
            @if (_selectedItems.Any())
            {
                                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Backup"
                           Disabled="@_isMassBackingUp"
                           OnClick="BackupSelected">
                    @( _isMassBackingUp ? L["Devices_MassBackup_Progress"] : $"{L["Devices_BackupSelected"]} ({_selectedItems.Count})")
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.Delete"
                           Disabled="@_isMassBackingUp"
                           OnClick="DeleteSelected">
                    @L["Devices_DeleteSelected"] (@_selectedItems.Count)
                </MudButton>
            }
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="OpenScanDialog" StartIcon="@Icons.Material.Filled.Search">
                @L["Devices_Scan"]
            </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddDeviceDialog" StartIcon="@Icons.Material.Filled.Add">
                @L["Devices_AddDevice"]
            </MudButton>
        </MudStack>
    </div>
    

        <!-- MudStack for Search removed here, moved into Mobile View -->

    @if (_loading)
    {
         <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else if (!_devices.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">@L["Devices_NoDevices"]</MudAlert>
    }
        else
    {
            <!-- Mobile View: Cards -->
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudGrid class="mb-4">
                <MudItem xs="8">
                    <MudTextField @bind-Value="_searchString" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>                    
                </MudItem>    
                <MudItem xs="4">
                    <MudSelect T="DeviceType?" @bind-Value="_filterType" Clearable="true" Placeholder="@L["Devices_Table_Type"]">
                        @foreach (DeviceType type in Enum.GetValues(typeof(DeviceType)))
                        {
                            <MudSelectItem Value="(DeviceType?)type">@type</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>           

            <MudGrid Class="mb-4">
                @foreach (var device in _devices.Where(FilterDevices))
                {
                    <MudItem xs="12">
                        <MudCard Elevation="3">
                                                                                    <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@device.Name</MudText>
                                    <MudLink Href="@($"http://{device.IpAddress}")" Target="_blank" Underline="Underline.Hover">@device.IpAddress</MudLink>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@device.Type</MudChip>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">Firmware: @(device.CurrentFirmwareVersion ?? "-")</MudText>
                                    
                                    <div class="d-flex align-center gap-1">
                                        @if (device.AutoBackupOverride == false)
                                        {
                                            <MudTooltip Text="@L["Devices_AutoBackup_Excluded"]">
                                                <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Color="Color.Default" Size="Size.Small" />
                                            </MudTooltip>
                                        }
                                        @if (device.BackupFailures > 0)
                                        {
                                            <MudTooltip Text="@L["Devices_Backup_Failure_LastFailed"]">
                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                                            </MudTooltip>
                                        }
                                        
                                        @if (device.LastBackup.HasValue)
                                        {
                                            var daysSince = (DateTime.UtcNow - device.LastBackup.Value).TotalDays;
                                            var color = daysSince > 30 ? Color.Error : (daysSince > 7 ? Color.Warning : Color.Default);
                                            
                                            <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="@color"/>
                                            <MudText Typo="Typo.body2">@device.LastBackup.Value.ToLocalTime().ToString("g")</MudText>
                                        }
                                    </div>
                                </MudStack>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@(_isBackingUp.Contains(device.Id) ? null : Icons.Material.Filled.Backup)"
                                           Disabled="@(_isBackingUp.Contains(device.Id))"
                                           OnClick="@(() => BackupDevice(device))">
                                    @if (_isBackingUp.Contains(device.Id))
                                    {
                                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    }
                                    else
                                    {
                                        @L["Common_Backup"]
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.History" OnClick="@(() => NavigateToBackups(device.Id))">
                                    @L["Common_Backups"] (@device.Backups.Count)
                                </MudButton>
                                <MudSpacer />
                                                                                                <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                    <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditDevice(device))">@L["Common_Edit"]</MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteDevice(device))" IconColor="Color.Error">@L["Common_Delete"]</MudMenuItem>
                                </MudMenu>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudHidden>

        <!-- Desktop View: DataGrid -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid Items="@_devices" MultiSelection="true" @bind-SelectedItems="_selectedItems" Hover="true" Elevation="3" Filterable="true" SortMode="SortMode.Multiple" QuickFilter="@_quickFilter">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">@L["Devices_Title"]</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Placeholder="@L["Common_Search"]" Adornment="Adornment.Start" Immediate="true"
                        AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <Columns>
                    <SelectColumn T="Device" />
                                        <PropertyColumn Property="x => x.Name" Title="@L["Devices_Table_Name"]" Filterable="false" />
                    <PropertyColumn Property="x => x.IpAddress" Title="@L["Devices_Table_IpAddress"]" Filterable="false">
                        <CellTemplate>
                             <MudLink Href="@($"http://{context.Item.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.Item.IpAddress</MudLink>
                        </CellTemplate>
                    </PropertyColumn>
                                                            <PropertyColumn Property="x => x.Type" Title="@L["Devices_Table_Type"]">
                        <CellTemplate>
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@context.Item.Type</MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.CurrentFirmwareVersion" Title="Firmware" Filterable="false" />
                                        <PropertyColumn Property="x => x.LastBackup" Title="@L["Devices_Table_LastBackup"]">
                         <CellTemplate>
                            <div class="d-flex align-center gap-2">
                                @if (context.Item.AutoBackupOverride == false)
                                {
                                    <MudTooltip Text="@L["Devices_AutoBackup_Excluded"]">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Color="Color.Default" Size="Size.Small" />
                                        </div>
                                    </MudTooltip>
                                }
                                @if (context.Item.BackupFailures > 0)
                                {
                                    <MudTooltip Text="@L["Devices_Backup_Failure_LastFailed"]">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                                        </div>
                                    </MudTooltip>
                                }
                                
                                                                @if (context.Item.LastBackup.HasValue)
                                {
                                    var daysSince = (DateTime.UtcNow - context.Item.LastBackup.Value).TotalDays;
                                    var color = daysSince > 30 ? Color.Error : (daysSince > 7 ? Color.Warning : Color.Default);
                                    
                                                                        <div class="d-flex align-center gap-1">
                                         <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="@color"/>
                                         <MudText Typo="Typo.body2">@FormatDate(context.Item.LastBackup)</MudText>
                                    </div>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                                }
                            </div>
                         </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Sortable="false" Filterable="false">
                        <CellTemplate>
                             <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                                <MudButton Variant="Variant.Outlined" 
                                    Color="Color.Primary" 
                                    Size="Size.Small" 
                                    StartIcon="@(_isBackingUp.Contains(context.Item.Id) ? null : Icons.Material.Filled.Backup)"
                                    Disabled="@(_isBackingUp.Contains(context.Item.Id))"
                                    OnClick="@(() => BackupDevice(context.Item))">
                                     @if (_isBackingUp.Contains(context.Item.Id))
                                     {
                                         <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                         <MudText Class="ms-2">@L["Common_BackupInProgress"]</MudText>
                                     }
                                     else
                                     {
                                         <MudText>@L["Common_Backup"]</MudText>
                                     }
                                 </MudButton>

                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.History"
                                           OnClick="@(() => NavigateToBackups(context.Item.Id))">
                                    @L["Common_Backups"] (@context.Item.Backups.Count)
                                </MudButton>

                                                                                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                     <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditDevice(context.Item))">@L["Common_Edit"]</MudMenuItem>
                                     <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteDevice(context.Item))" IconColor="Color.Error">@L["Common_Delete"]</MudMenuItem>
                                </MudMenu>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudHidden>
    }


@code {
    private List<Device> _devices = new();
    private HashSet<Device> _selectedItems = new();
    private bool _loading = true;
            private HashSet<int> _isBackingUp = new();
    private bool _isMassBackingUp = false;
    private string _searchString = "";
    private DeviceType? _filterType;
    // ...
    private AppSettings? _settings; // We need settings loaded for preference

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await LoadDevices();
    }

    private async Task LoadSettings()
    {
        _settings = await Context.Settings.FindAsync(1);
    }
    
    // ...
    
    // Helper for formatting
    private string FormatDate(DateTime? date)
    {
        if (!date.HasValue) return "-";
        
        if (_settings?.UseRelativeTime == true)
        {
            return date.Value.Humanize(); 
        }
        else
        {
            return date.Value.ToLocalTime().ToString("g");
        }
    }
    
        
    // QuickFilter for DataGrid
    private Func<Device, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.IpAddress.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Type.ToString().Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private bool FilterDevices(Device device)
    {
        // Type Filter
        if (_filterType.HasValue && device.Type != _filterType.Value) return false;

        // Search Filter
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        if (device.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (device.IpAddress.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (device.Type.ToString().Contains(_searchString, StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }
    
    private string GetSortableIp(string ipAddress)
    {
        // Pad IPv4 segments with zeros for alphanumeric sorting (e.g. 192.168.1.2 -> 192.168.001.002)
        if (System.Net.IPAddress.TryParse(ipAddress, out var ip))
        {
             var bytes = ip.GetAddressBytes();
             if (bytes.Length == 4) 
             {
                 return $"{bytes[0]:000}.{bytes[1]:000}.{bytes[2]:000}.{bytes[3]:000}";
             }
        }
        return ipAddress;
    }

    private async Task LoadDevices()
    {
        _loading = true;
        _devices = await Context.Devices.Include(d => d.Backups).ToListAsync();
        _loading = false;
    }

    private void NavigateToBackups(int deviceId)
    {
        NavigationManager.NavigateTo($"backups/{deviceId}");
    }

        private async Task OpenScanDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ScanDialog>(L["Scan_Title"], parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await LoadDevices();
        }
    }

    private async Task OpenAddDeviceDialog()
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<AddDeviceDialog>(L["AddDevice_Title"], parameters);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await LoadDevices();
        }
    }

        private async Task EditDevice(Device device)
    {
        var parameters = new DialogParameters
        {
            { nameof(EditDeviceDialog.DeviceId), device.Id },
            { nameof(EditDeviceDialog.CurrentName), device.Name },
            { nameof(EditDeviceDialog.ExcludeFromAutoBackup), device.AutoBackupOverride == false }
        };

        var dialog = await DialogService.ShowAsync<EditDeviceDialog>(L["EditDevice_Title"], parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
             await LoadDevices();
         }
    }

    private async Task BackupDevice(Device device)
    {
        if (_isBackingUp.Contains(device.Id)) return;

        _isBackingUp.Add(device.Id);
        StateHasChanged();

                try
        {
            await BackupService.PerformBackupAsync(device.Id);
        }
        catch(Exception ex)
        {
            Snackbar.Add(String.Format(L["Devices_Backup_Error"], device.Name, ex.Message), Severity.Error);
        }
        finally
        {
            _isBackingUp.Remove(device.Id);
            StateHasChanged();
        }
    }

    private async Task BackupSelected()
    {
        if (!_selectedItems.Any() || _isMassBackingUp) return;

        _isMassBackingUp = true;
        var itemsToBackup = _selectedItems.ToList();
        
        try
        {
            foreach (var device in itemsToBackup)
            {
                await BackupDevice(device);
            }
            
            await LoadDevices();
            Snackbar.Add(String.Format(L["Devices_MassBackup_Success"], itemsToBackup.Count), Severity.Success);
        }
        finally
        {
            _isMassBackingUp = false;
            _selectedItems.Clear();
            StateHasChanged();
        }
    }

    private async Task DeleteDevice(Device device)
    {
        bool hasLockedBackups = device.Backups.Any(b => b.IsLocked);
        if (hasLockedBackups)
        {
            await DialogService.ShowMessageBox(
                L["Devices_Delete_LockedBackups_Title"],
                String.Format(L["Devices_Delete_LockedBackups_Message"], device.Name),
                L["Common_Understand"]);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            L["Devices_Delete_Confirm_Title"],
            String.Format(L["Devices_Delete_Confirm_Message"], device.Name),
            yesText: L["Common_Delete"], cancelText: L["Common_Cancel"]);

        if (result == true)
        {
            foreach (var backup in device.Backups)
            {
                await ExecuteFileCleanup(backup);
            }

            Context.Devices.Remove(device);
            await Context.SaveChangesAsync();
            await LoadDevices();
            Snackbar.Add(L["Devices_Delete_Success"], Severity.Success);
        }
    }

    private async Task DeleteSelected()
    {
        if (!_selectedItems.Any()) return;

        var devicesWithLockedBackups = _selectedItems.Where(d => d.Backups.Any(b => b.IsLocked)).ToList();
        if (devicesWithLockedBackups.Any())
        {
            var names = string.Join(", ", devicesWithLockedBackups.Select(d => d.Name));
            await DialogService.ShowMessageBox(
                L["Devices_Delete_LockedBackups_Title"],
                String.Format(L["Devices_DeleteSelected_LockedBackups_Message"], names),
                L["Common_Understand"]);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            L["Devices_DeleteSelected_Confirm_Title"],
            String.Format(L["Devices_DeleteSelected_Confirm_Message"], _selectedItems.Count),
            yesText: L["Common_Delete"], cancelText: L["Common_Cancel"]);

        if (result == true)
        {
            foreach (var device in _selectedItems)
            {
                foreach (var backup in device.Backups)
                {
                    await ExecuteFileCleanup(backup);
                }
            }

            Context.Devices.RemoveRange(_selectedItems);
            await Context.SaveChangesAsync();
            _selectedItems.Clear();
            await LoadDevices();
            Snackbar.Add(L["Devices_DeleteSelected_Success"], Severity.Success);
        }
    }

    private async Task ExecuteFileCleanup(Backup backup)
    {
        try
        {
            var otherBackupsUsingFile = await Context.Backups
                .AnyAsync(b => b.StoragePath == backup.StoragePath && b.Id != backup.Id);

            if (!otherBackupsUsingFile)
            {
                var backupDirectory = Environment.GetEnvironmentVariable("backup_path") ?? Path.Combine(Directory.GetCurrentDirectory(), "backups");
                var path = Path.Combine(backupDirectory, backup.StoragePath);
                if (File.Exists(path))
                {
                    File.Delete(path);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Warning: Could not delete file {backup.StoragePath}: {ex.Message}");
        }
    }
}


