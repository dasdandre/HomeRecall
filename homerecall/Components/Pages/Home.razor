@page "/"
@rendermode InteractiveServer
@using HomeRecall.Services
@using Microsoft.EntityFrameworkCore
@inject BackupContext Context
@inject IBackupService BackupService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">Geräte</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddDeviceDialog" StartIcon="@Icons.Material.Filled.Add">
            Neues Gerät
        </MudButton>
    </div>

    @if (_loading)
    {
         <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else if (!_devices.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">Keine Geräte vorhanden. Fügen Sie eines hinzu!</MudAlert>
    }
    else
    {
        <MudTable Items="@_devices" Hover="true" Elevation="3" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>IP Adresse</MudTh>
                <MudTh>Typ</MudTh>
                <MudTh>Letztes Backup</MudTh>
                <MudTh Style="text-align:right">Aktionen</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body1" Style="font-weight: 500;">@context.Name</MudText>
                </MudTd>
                <MudTd DataLabel="IP Adresse">
                    <MudLink Href="@($"http://{context.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.IpAddress</MudLink>
                </MudTd>
                <MudTd DataLabel="Typ">
                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@context.Type</MudChip>
                </MudTd>
                <MudTd DataLabel="Letztes Backup">
                    @if (context.LastBackup.HasValue)
                    {
                        <div class="d-flex align-center gap-1">
                             <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Default"/>
                             <MudText Typo="Typo.body2">@context.LastBackup.Value.ToLocalTime().ToString("g")</MudText>
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Aktionen" Style="text-align:right">
                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                         <MudButton Variant="Variant.Outlined" 
                                    Color="Color.Primary" 
                                    Size="Size.Small" 
                                    StartIcon="@Icons.Material.Filled.Backup"
                                    OnClick="@(() => BackupDevice(context))">
                             Backup
                         </MudButton>

                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Secondary" 
                                   Size="Size.Small" 
                                   StartIcon="@Icons.Material.Filled.History"
                                   OnClick="@(() => NavigateToBackups(context.Id))">
                            Backups (@context.Backups.Count)
                        </MudButton>
                        
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                             <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => RenameDevice(context))">Umbenennen</MudMenuItem>
                             <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteDevice(context))" IconColor="Color.Error">Löschen</MudMenuItem>
                        </MudMenu>
                    </MudStack>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Device> _devices = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDevices();
    }

    private async Task LoadDevices()
    {
        _loading = true;
        _devices = await Context.Devices.Include(d => d.Backups).ToListAsync();
        _loading = false;
    }

    private void NavigateToBackups(int deviceId)
    {
        NavigationManager.NavigateTo($"/backups/{deviceId}");
    }

    private async Task OpenAddDeviceDialog()
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<AddDeviceDialog>("Gerät hinzufügen", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadDevices();
        }
    }

    private async Task RenameDevice(Device device)
    {
        var parameters = new DialogParameters
        {
            { nameof(RenameDeviceDialog.DeviceId), device.Id },
            { nameof(RenameDeviceDialog.CurrentName), device.Name }
        };
        
        var dialog = await DialogService.ShowAsync<RenameDeviceDialog>("Gerät umbenennen", parameters);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await LoadDevices();
        }
    }

    private async Task BackupDevice(Device device)
    {
        Snackbar.Add($"Backup für {device.Name} gestartet...", Severity.Info);
        // Wir lassen das asynchron laufen, aber aktualisieren die Liste danach nicht sofort, da es dauern kann.
        // Optional könnte man hier einen Spinner am Button anzeigen.
        try 
        {
            await BackupService.PerformBackupAsync(device.Id);
            await LoadDevices(); // Reload to update "Last Backup" and count
            Snackbar.Add($"Backup für {device.Name} erfolgreich.", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Fehler beim Backup: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task DeleteDevice(Device device)
    {
         bool? result = await DialogService.ShowMessageBox(
            "Gerät löschen", 
            $"Sind Sie sicher, dass Sie '{device.Name}' löschen möchten? Alle zugehörigen Backups werden ebenfalls gelöscht.", 
            yesText:"Löschen", cancelText:"Abbrechen");
            
         if (result == true)
         {
             Context.Devices.Remove(device);
             await Context.SaveChangesAsync();
             await LoadDevices();
             Snackbar.Add("Gerät gelöscht", Severity.Success);
         }
    }
}