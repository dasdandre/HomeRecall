@page "/"
@using HomeRecall.Services
@using Microsoft.EntityFrameworkCore
@inject BackupContext Context
@inject IBackupService BackupService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">Geräte</MudText>
        <MudStack Row="true" Spacing="2">
            @if (_selectedItems.Any())
            {
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Backup"
                           Disabled="@_isMassBackingUp"
                           OnClick="BackupSelected">
                    @( _isMassBackingUp ? "Backing up..." : $"Backup Selected ({_selectedItems.Count})")
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.Delete"
                           Disabled="@_isMassBackingUp"
                           OnClick="DeleteSelected">
                    Delete Selected (@_selectedItems.Count)
                </MudButton>
            }
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddDeviceDialog" StartIcon="@Icons.Material.Filled.Add">
                Neues Gerät
            </MudButton>
        </MudStack>
    </div>

    @if (_loading)
    {
         <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else if (!_devices.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">Keine Geräte vorhanden. Fügen Sie eines hinzu!</MudAlert>
    }
    else
    {
        <MudTable Items="@_devices" MultiSelection="true" @bind-SelectedItems="_selectedItems" Hover="true" Elevation="3" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>IP Adresse</MudTh>
                <MudTh>Typ</MudTh>
                <MudTh>Letztes Backup</MudTh>
                <MudTh Style="text-align:right">Aktionen</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body1" Style="font-weight: 500;">@context.Name</MudText>
                </MudTd>
                <MudTd DataLabel="IP Adresse">
                    <MudLink Href="@($"http://{context.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.IpAddress</MudLink>
                </MudTd>
                <MudTd DataLabel="Typ">
                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@context.Type</MudChip>
                </MudTd>
                <MudTd DataLabel="Letztes Backup">
                    @if (context.LastBackup.HasValue)
                    {
                        <div class="d-flex align-center gap-1">
                             <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Default"/>
                             <MudText Typo="Typo.body2">@context.LastBackup.Value.ToLocalTime().ToString("g")</MudText>
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Aktionen" Style="text-align:right">
                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                         <MudButton Variant="Variant.Outlined" 
                                    Color="Color.Primary" 
                                    Size="Size.Small" 
                                    StartIcon="@(_isBackingUp.Contains(context.Id) ? null : Icons.Material.Filled.Backup)"
                                    Disabled="@(_isBackingUp.Contains(context.Id))"
                                    OnClick="@(() => BackupDevice(context))">
                             @if (_isBackingUp.Contains(context.Id))
                             {
                                 <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                 <MudText Class="ms-2">Backup...</MudText>
                             }
                             else
                             {
                                 <MudText>Backup</MudText>
                             }
                         </MudButton>

                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.History"
                                   OnClick="@(() => NavigateToBackups(context.Id))">
                            Backups (@context.Backups.Count)
                        </MudButton>

                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                             <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => RenameDevice(context))">Umbenennen</MudMenuItem>
                             <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteDevice(context))" IconColor="Color.Error">Löschen</MudMenuItem>
                        </MudMenu>
                    </MudStack>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Device> _devices = new();
    private HashSet<Device> _selectedItems = new();
    private bool _loading = true;
    private HashSet<int> _isBackingUp = new();
    private bool _isMassBackingUp = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDevices();
    }

    private async Task LoadDevices()
    {
        _loading = true;
        _devices = await Context.Devices.Include(d => d.Backups).ToListAsync();
        _loading = false;
    }

    private void NavigateToBackups(int deviceId)
    {
        NavigationManager.NavigateTo($"backups/{deviceId}");
    }

    private async Task OpenAddDeviceDialog()
    {
        var parameters = new DialogParameters();
        var dialog = await DialogService.ShowAsync<AddDeviceDialog>("Gerät hinzufügen", parameters);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await LoadDevices();
        }
    }

    private async Task RenameDevice(Device device)
    {
        var parameters = new DialogParameters
        {
            { nameof(RenameDeviceDialog.DeviceId), device.Id },
            { nameof(RenameDeviceDialog.CurrentName), device.Name }
        };

        var dialog = await DialogService.ShowAsync<RenameDeviceDialog>("Gerät umbenennen", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
             await LoadDevices();
         }
    }

    private async Task BackupDevice(Device device)
    {
        if (_isBackingUp.Contains(device.Id)) return;

        _isBackingUp.Add(device.Id);
        StateHasChanged();

        try
        {
            await BackupService.PerformBackupAsync(device.Id);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Fehler beim Backup von {device.Name}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isBackingUp.Remove(device.Id);
            StateHasChanged();
        }
    }

    private async Task BackupSelected()
    {
        if (!_selectedItems.Any() || _isMassBackingUp) return;

        _isMassBackingUp = true;
        var itemsToBackup = _selectedItems.ToList();
        
        try
        {
            foreach (var device in itemsToBackup)
            {
                await BackupDevice(device);
            }
            
            await LoadDevices();
            Snackbar.Add($"{itemsToBackup.Count} Backups abgeschlossen.", Severity.Success);
        }
        finally
        {
            _isMassBackingUp = false;
            _selectedItems.Clear();
            StateHasChanged();
        }
    }

    private async Task DeleteDevice(Device device)
    {
        bool hasLockedBackups = device.Backups.Any(b => b.IsLocked);
        if (hasLockedBackups)
        {
            await DialogService.ShowMessageBox(
                "Löschen nicht möglich",
                $"Das Gerät '{device.Name}' hat gesperrte Backups. Bitte entsperren oder löschen Sie diese zuerst, bevor Sie das Gerät entfernen.",
                "Verstanden");
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Gerät löschen",
            $"Sind Sie sicher, dass Sie '{device.Name}' löschen möchten? Alle zugehörigen Backups werden ebenfalls gelöscht.",
            yesText: "Löschen", cancelText: "Abbrechen");

        if (result == true)
        {
            foreach (var backup in device.Backups)
            {
                await ExecuteFileCleanup(backup);
            }

            Context.Devices.Remove(device);
            await Context.SaveChangesAsync();
            await LoadDevices();
            Snackbar.Add("Gerät und zugehörige Backups gelöscht", Severity.Success);
        }
    }

    private async Task DeleteSelected()
    {
        if (!_selectedItems.Any()) return;

        var devicesWithLockedBackups = _selectedItems.Where(d => d.Backups.Any(b => b.IsLocked)).ToList();
        if (devicesWithLockedBackups.Any())
        {
            var names = string.Join(", ", devicesWithLockedBackups.Select(d => d.Name));
            await DialogService.ShowMessageBox(
                "Löschen nicht möglich",
                $"Einige Geräte haben gesperrte Backups: {names}. Bitte bereinigen Sie diese zuerst.",
                "Verstanden");
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Ausgewählte Geräte löschen",
            $"Sind Sie sicher, dass Sie {_selectedItems.Count} Geräte und alle deren Backups löschen möchten?",
            yesText: "Löschen", cancelText: "Abbrechen");

        if (result == true)
        {
            foreach (var device in _selectedItems)
            {
                foreach (var backup in device.Backups)
                {
                    await ExecuteFileCleanup(backup);
                }
            }

            Context.Devices.RemoveRange(_selectedItems);
            await Context.SaveChangesAsync();
            _selectedItems.Clear();
            await LoadDevices();
            Snackbar.Add("Geräte gelöscht", Severity.Success);
        }
    }

    private async Task ExecuteFileCleanup(Backup backup)
    {
        try
        {
            var otherBackupsUsingFile = await Context.Backups
                .AnyAsync(b => b.StoragePath == backup.StoragePath && b.Id != backup.Id);

            if (!otherBackupsUsingFile)
            {
                var backupDirectory = Environment.GetEnvironmentVariable("backup_path") ?? Path.Combine(Directory.GetCurrentDirectory(), "backups");
                var path = Path.Combine(backupDirectory, backup.StoragePath);
                if (File.Exists(path))
                {
                    File.Delete(path);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Warning: Could not delete file {backup.StoragePath}: {ex.Message}");
        }
    }
}


