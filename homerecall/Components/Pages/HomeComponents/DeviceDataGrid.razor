@using HomeRecall
@using HomeRecall.Services
@using Microsoft.Extensions.Localization
@using Humanizer
@using HomeRecall.Components
@inject IStringLocalizer<SharedResource> L

<!-- Desktop View: DataGrid -->
<!-- Displayed on large screens (md and up) -->
<MudHidden Breakpoint="Breakpoint.SmAndDown">
    <MudDataGrid Items="@Devices" MultiSelection="true" SelectedItems="SelectedItems" SelectedItemsChanged="SelectedItemsChanged" Hover="true" Elevation="3" Filterable="true" SortMode="SortMode.Multiple" QuickFilter="@QuickFilter">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@L["Devices_Title"]</MudText>
            <MudSpacer />
            <!-- Global Search Field -->
            <MudTextField Value="@SearchString" ValueChanged="@(new Func<string, Task>(OnSearchChanged))" Placeholder="@L["Common_Search"]" Adornment="Adornment.Start" Immediate="true"
                AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <Columns>
            <SelectColumn T="Device" />
            
            <PropertyColumn Property="x => x.Name" Title="@L["Devices_Table_Name"]" Filterable="false" />
            
            <PropertyColumn Property="x => x.IpAddress" Title="@L["Devices_Table_IpAddress"]" Filterable="false">
                <CellTemplate>
                        <MudLink Href="@($"http://{context.Item.IpAddress}")" Target="_blank" Underline="Underline.Hover">@context.Item.IpAddress</MudLink>
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.Type" Title="@L["Devices_Table_Type"]">
                <CellTemplate>
                    <MudChip T="string" Color="@UiHelpers.GetColorForDeviceType(context.Item.Type)" Size="Size.Small" Variant="Variant.Text">@context.Item.Type</MudChip>
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.CurrentFirmwareVersion" Title="Firmware" Filterable="false" />
            
            <!-- Last Backup Column (includes status icons) -->
            <PropertyColumn Property="x => x.LastBackup" Title="@L["Devices_Table_LastBackup"]">
                    <CellTemplate>
                    <div class="d-flex align-center gap-2">
                        @if (context.Item.AutoBackupOverride == false)
                        {
                            <MudTooltip Text="@L["Devices_AutoBackup_Excluded"]">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Color="Color.Default" Size="Size.Small" />
                                </div>
                            </MudTooltip>
                        }
                        @if (context.Item.BackupFailures > 0)
                        {
                            <MudTooltip Text="@L["Devices_Backup_Failure_LastFailed"]">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                                </div>
                            </MudTooltip>
                        }
                        
                        @if (context.Item.LastBackup.HasValue)
                        {
                            var daysSince = (DateTime.UtcNow - context.Item.LastBackup.Value).TotalDays;
                            var color = daysSince > 30 ? Color.Error : (daysSince > 7 ? Color.Warning : Color.Default);
                            
                            <div class="d-flex align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="@color"/>
                                    <MudText Typo="Typo.body2">@FormatDate(context.Item.LastBackup)</MudText>
                            </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                        }
                    </div>
                    </CellTemplate>
            </PropertyColumn>

            <!-- Action Buttons Column -->
            <TemplateColumn Sortable="false" Filterable="false">
                <CellTemplate>
                    <div class="d-flex justify-end w-100">
                        <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">                           
                            @if (IsBackingUp.Contains(context.Item.Id))
                            {
                                <MudButton Color="Color.Primary" Disabled="true">
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                </MudButton>
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Save"
                                               Color="Color.Primary"
                                               OnClick="@(() => OnBackupDevice.InvokeAsync(context.Item))" />
                            }
                        
                            <MudButton Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.History"
                                       OnClick="@(() => OnNavigateToBackups.InvokeAsync(context.Item.Id))">
                                @(context.Item.Backups.Count > 0 ? context.Item.Backups.Count.ToString() : "-")
                            </MudButton>

                            <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Style="align-self: auto;">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OnEditDevice.InvokeAsync(context.Item))">@L["Common_Edit"]</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => OnDeleteDevice.InvokeAsync(context.Item))" IconColor="Color.Error">@L["Common_Delete"]</MudMenuItem>
                            </MudMenu>                          
                        </MudButtonGroup>
                    </div>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudHidden>

@code {
    [Parameter] public List<Device> Devices { get; set; } = new();
    [Parameter] public HashSet<Device> SelectedItems { get; set; } = new();
    [Parameter] public EventCallback<HashSet<Device>> SelectedItemsChanged { get; set; }

    [Parameter] public HashSet<int> IsBackingUp { get; set; } = new();
    [Parameter] public string SearchString { get; set; } = "";
    [Parameter] public EventCallback<string> SearchStringChanged { get; set; }

    [Parameter] public Func<Device, bool> QuickFilter { get; set; } = _ => true;
    [Parameter] public AppSettings? Settings { get; set; }

    // Action Callbacks
    [Parameter] public EventCallback<Device> OnBackupDevice { get; set; }
    [Parameter] public EventCallback<int> OnNavigateToBackups { get; set; }
    [Parameter] public EventCallback<Device> OnEditDevice { get; set; }
    [Parameter] public EventCallback<Device> OnDeleteDevice { get; set; }

    private async Task OnSearchChanged(string value)
    {
        SearchString = value;
        await SearchStringChanged.InvokeAsync(value);
    }

    private string FormatDate(DateTime? date)
    {
        if (!date.HasValue) return "-";
        
        if (Settings?.UseRelativeTime == true)
        {
            return date.Value.Humanize(); 
        }
        else
        {
            return date.Value.ToLocalTime().ToString("g");
        }
    }
}
