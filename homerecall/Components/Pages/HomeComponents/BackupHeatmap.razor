@using HomeRecall.Persistence.Entities
@using MudBlazor

<div class="backup-heatmap-container">
    <div class="d-flex align-center justify-space-between mb-2">
        <MudText Typo="Typo.subtitle2">Last @DaysToShow Days</MudText>
        <div class="d-flex align-center gap-2">
            <MudText Typo="Typo.caption" Class="mud-text-secondary">Less</MudText>
            <div class="heatmap-legend-item level-0"></div>
            <div class="heatmap-legend-item level-1"></div>
            <div class="heatmap-legend-item level-2"></div>
            <div class="heatmap-legend-item level-3"></div>
            <div class="heatmap-legend-item level-4"></div>
            <MudText Typo="Typo.caption" Class="mud-text-secondary">More</MudText>
        </div>
    </div>
    
    <div class="backup-heatmap">
        @foreach (var week in GetWeeks())
        {
            <div class="heatmap-week">
                @foreach (var day in week)
                {
                    if (day.HasValue)
                    {
                        var count = GetCountForDay(day.Value);
                        var tooltipText = $"{count} backup{(count == 1 ? "" : "s")} on {day.Value:MMM d, yyyy}";
                        
                        <MudTooltip Text="@tooltipText" Placement="Placement.Top">
                            <div class="heatmap-day @GetCssClass(count)"></div>
                        </MudTooltip>
                    }
                    else
                    {
                        <div class="heatmap-day empty"></div>
                    }
                }
            </div>
        }
    </div>
</div>

<style>
    .backup-heatmap-container {
        width: 100%;
        overflow-x: auto;
    }
    .backup-heatmap {
        display: flex;
        gap: 4px;
    }
    .heatmap-week {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .heatmap-day {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        background-color: var(--mud-palette-action-disabled-background);
    }
    .heatmap-day.empty {
        background-color: transparent;
    }
    .heatmap-day.level-0, .heatmap-legend-item.level-0 {
        background-color: var(--mud-palette-action-disabled-background);
    }
    .heatmap-day.level-1, .heatmap-legend-item.level-1 {
        background-color: #a5d6a7;
    }
    .heatmap-day.level-2, .heatmap-legend-item.level-2 {
        background-color: #66bb6a;
    }
    .heatmap-day.level-3, .heatmap-legend-item.level-3 {
        background-color: #43a047;
    }
    .heatmap-day.level-4, .heatmap-legend-item.level-4 {
        background-color: #2e7d32;
    }
    
    .heatmap-legend-item {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
</style>

@code {
    [Parameter]
    public List<Backup> Backups { get; set; } = new();
    
    [Parameter]
    public int DaysToShow { get; set; } = 90;

    private Dictionary<DateTime, int> _cache = new();

    protected override void OnParametersSet()
    {
        _cache.Clear();
        foreach (var backup in Backups)
        {
            var date = backup.CreatedAt.Date;
            if (_cache.ContainsKey(date))
                _cache[date]++;
            else
                _cache[date] = 1;
        }
    }

    private int GetCountForDay(DateTime date)
    {
        if (_cache.TryGetValue(date.Date, out var count))
        {
            return count;
        }
        return 0;
    }

    private string GetCssClass(int count)
    {
        if (count == 0) return "level-0";
        if (count == 1) return "level-1";
        if (count == 2) return "level-2";
        if (count == 3) return "level-3";
        return "level-4";
    }

    private List<List<DateTime?>> GetWeeks()
    {
        var endDate = DateTime.UtcNow.Date;
        var startDate = endDate.AddDays(-DaysToShow + 1);
        
        // Adjust start date to first day of week (Sunday)
        while (startDate.DayOfWeek != DayOfWeek.Sunday)
        {
            startDate = startDate.AddDays(-1);
        }

        var weeks = new List<List<DateTime?>>();
        var currentWeek = new List<DateTime?>();
        var currentDate = startDate;

        while (currentDate <= endDate)
        {
            if (currentDate >= endDate.AddDays(-DaysToShow + 1))
            {
                currentWeek.Add(currentDate);
            }
            else
            {
                currentWeek.Add(null);
            }
            
            if (currentDate.DayOfWeek == DayOfWeek.Saturday)
            {
                weeks.Add(currentWeek);
                currentWeek = new List<DateTime?>();
            }
            
            currentDate = currentDate.AddDays(1);
        }
        
        if (currentWeek.Count > 0)
        {
            while (currentWeek.Count < 7)
            {
                currentWeek.Add(null);
            }
            weeks.Add(currentWeek);
        }

        return weeks;
    }
}
