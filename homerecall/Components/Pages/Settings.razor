@page "/settings"

<MudText Typo="Typo.h4">@L["Settings_Title"]</MudText>

<MudPaper Class="pa-4 mt-4">
    <MudText Typo="Typo.h6" Class="mb-4">@L["Settings_Language"]</MudText>
    <MudSelect T="string" Label="@L["Settings_Language"]" Value="@_currentLanguage" ValueChanged="ChangeLanguage">
        <MudSelectItem Value="@("auto")">@L["Settings_Language_Auto"]</MudSelectItem>
        <MudSelectItem Value="@("en")">@L["Settings_Language_English"]</MudSelectItem>
        <MudSelectItem Value="@("de")">@L["Settings_Language_German"]</MudSelectItem>
    </MudSelect>
</MudPaper>

@if (_settings != null)
{
    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">@L["Settings_Appearance_Title"]</MudText>
        <MudSwitch @bind-Value="_settings.UseRelativeTime" Color="Color.Primary" Label="@L["Settings_Appearance_RelativeTime"]" />
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">@L["Settings_AutoBackup_Title"]</MudText>
        
        <MudSwitch @bind-Value="_settings.AutoBackupEnabled" Color="Color.Primary" Label="@L["Settings_AutoBackup_Enabled"]" />

        <MudCollapse Expanded="_settings.AutoBackupEnabled">
            <MudGrid Class="mt-2">
                                <MudItem xs="12" sm="6">
                    <MudSelect T="int" Label="@L["Settings_BackupInterval"]" @bind-Value="_settings.BackupIntervalHours">
                        <MudSelectItem Value="12">@L["Settings_Interval_12h"]</MudSelectItem>
                        <MudSelectItem Value="24">@L["Settings_Interval_Daily"]</MudSelectItem>
                        <MudSelectItem Value="168">@L["Settings_Interval_Weekly"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudSelect T="RetentionMode" Label="@L["Settings_RetentionStrategy"]" @bind-Value="_settings.RetentionMode">
                        <MudSelectItem Value="RetentionMode.Smart">@L["Settings_Retention_Smart"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.SimpleDays">@L["Settings_Retention_SimpleDays"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.SimpleCount">@L["Settings_Retention_SimpleCount"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.KeepAll">@L["Settings_Retention_KeepAll"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                 @if (_settings.RetentionMode == RetentionMode.SimpleDays)
                 {
                     <MudItem xs="12">
                         <MudNumericField @bind-Value="_settings.MaxDaysToKeep" Label="@L["Settings_Retention_Days"]" Min="1" Max="3650" />
                     </MudItem>
                 }
                 
                 @if (_settings.RetentionMode == RetentionMode.SimpleCount)
                 {
                     <MudItem xs="12">
                         <MudNumericField @bind-Value="_settings.MaxCountToKeep" Label="@L["Settings_Retention_Count"]" Min="1" Max="1000" />
                     </MudItem>
                 }

                @if (_settings.RetentionMode == RetentionMode.Smart)
                {
                     <MudItem xs="12">
                         <MudAlert Severity="Severity.Info">@L["Settings_Retention_Smart_Info"]</MudAlert>
                     </MudItem>
                }
            </MudGrid>
        </MudCollapse>
        
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveSettings">@L["Common_Save"]</MudButton>
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">Local Device Discovery (mDNS)</MudText>
        <MudSwitch @bind-Value="_settings.MdnsEnabled" Color="Color.Primary" Label="Enable mDNS Auto-Discovery" />
        <MudText Typo="Typo.caption" Class="ml-2 d-block mb-4">Automatically discovers WLED and Shelly devices on your local network without manual IP scanning.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSettings">@L["Common_Save"]</MudButton>
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <div class="d-flex align-center mb-4">
            <MudText Typo="Typo.h6">@L["Settings_MQTT_Title"]</MudText>
            <MudSpacer />
            <MudChip T="string" Color="@(MqttService.Status switch { MqttConnectionStatus.Connected => Color.Success, MqttConnectionStatus.Connecting => Color.Warning, MqttConnectionStatus.Disabled => Color.Default, _ => Color.Error })" Size="Size.Small">
                @(MqttService.Status switch { 
                    MqttConnectionStatus.Connected => L["Settings_MQTT_Status_Connected"],
                    MqttConnectionStatus.Connecting => L["Settings_MQTT_Status_Connecting"],
                    MqttConnectionStatus.Disabled => L["Settings_MQTT_Status_Disabled"],
                    MqttConnectionStatus.Error => L["Settings_MQTT_Status_Error"],
                    _ => L["Settings_MQTT_Status_Disconnected"]
                })
            </MudChip>
        </div>

        @if (MqttService.Status == MqttConnectionStatus.Error && !string.IsNullOrEmpty(MqttService.LastErrorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@MqttService.LastErrorMessage</MudAlert>
        }

        <MudSwitch @bind-Value="_settings.MqttEnabled" Color="Color.Primary" Label="@L["Settings_MQTT_Enabled"]" />

        <MudCollapse Expanded="_settings.MqttEnabled">
            <MudGrid Class="mt-2">
                <MudItem xs="12" sm="8">
                    <MudTextField @bind-Value="_settings.MqttHost" Label="@L["Settings_MQTT_BrokerHost"]" Placeholder="e.g. 192.168.1.50" HelperText="@L["Settings_MQTT_BrokerHost_Helper"]" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField @bind-Value="_settings.MqttPort" Label="@L["Settings_MQTT_BrokerPort"]" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_settings.MqttUsername" Label="@L["Settings_MQTT_Username"]" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_mqttPassword" Label="@L["Settings_MQTT_Password"]" InputType="InputType.Password" />
                </MudItem>
                <MudItem xs="12">
                     <MudSwitch @bind-Value="_settings.MqttAutoAdd" Color="Color.Primary" Label="@L["Settings_MQTT_AutoAdd"]" />
                     <MudText Typo="Typo.caption" Class="ml-2">@L["Settings_MQTT_AutoAdd_Desc"]</MudText>
                </MudItem>

                @if (_mqttCapableStrategies.Any())
                {
                    <MudItem xs="12" Class="mt-2">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">@L["Settings_MQTT_DiscoveryFilter"]</MudText>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var strategy in _mqttCapableStrategies)
                            {
                                var typeStr = strategy.SupportedType.ToString();
                                var isExcluded = _excludedMqttTypes.Contains(typeStr);
                                <MudChip T="string"
                                         Text="@typeStr" 
                                         Color="@(isExcluded ? Color.Error : Color.Default)"
                                         Variant="@(isExcluded ? Variant.Filled : Variant.Outlined)"
                                         OnClick="@(() => ToggleMqttExclusion(strategy.SupportedType))" />
                            }
                        </div>
                    </MudItem>
                }
            </MudGrid>
        </MudCollapse>

        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveSettings">@L["Common_Save"]</MudButton>
    </MudPaper>
}

<MudText Class="mt-4">Current Backup Path: @(Environment.GetEnvironmentVariable("backup_path") ?? Path.Combine(Directory.GetCurrentDirectory(), "backups"))</MudText>
