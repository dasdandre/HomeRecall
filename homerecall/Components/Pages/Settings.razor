@page "/settings"
@using Microsoft.Extensions.Localization
@using System.Globalization
@using Microsoft.EntityFrameworkCore
@inject IStringLocalizer<SharedResource> L
@inject NavigationManager NavigationManager
@inject BackupContext Context
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4">@L["Settings_Title"]</MudText>

<MudPaper Class="pa-4 mt-4">
    <MudText Typo="Typo.h6" Class="mb-4">@L["Settings_Language"]</MudText>
    <MudSelect T="string" Label="@L["Settings_Language"]" Value="@_currentLanguage" ValueChanged="ChangeLanguage">
        <MudSelectItem Value="@("auto")">@L["Settings_Language_Auto"]</MudSelectItem>
        <MudSelectItem Value="@("en")">@L["Settings_Language_English"]</MudSelectItem>
        <MudSelectItem Value="@("de")">@L["Settings_Language_German"]</MudSelectItem>
    </MudSelect>
</MudPaper>

@if (_settings != null)
{
    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">@L["Settings_AutoBackup_Title"]</MudText>
        
        <MudSwitch @bind-Value="_settings.AutoBackupEnabled" Color="Color.Primary" Label="@L["Settings_AutoBackup_Enabled"]" />

        <MudCollapse Expanded="_settings.AutoBackupEnabled">
            <MudGrid Class="mt-2">
                                <MudItem xs="12" sm="6">
                    <MudSelect T="int" Label="@L["Settings_BackupInterval"]" @bind-Value="_settings.BackupIntervalHours">
                        <MudSelectItem Value="12">@L["Settings_Interval_12h"]</MudSelectItem>
                        <MudSelectItem Value="24">@L["Settings_Interval_Daily"]</MudSelectItem>
                        <MudSelectItem Value="168">@L["Settings_Interval_Weekly"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudSelect T="RetentionMode" Label="@L["Settings_RetentionStrategy"]" @bind-Value="_settings.RetentionMode">
                        <MudSelectItem Value="RetentionMode.Smart">@L["Settings_Retention_Smart"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.SimpleDays">@L["Settings_Retention_SimpleDays"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.SimpleCount">@L["Settings_Retention_SimpleCount"]</MudSelectItem>
                        <MudSelectItem Value="RetentionMode.KeepAll">@L["Settings_Retention_KeepAll"]</MudSelectItem>
                    </MudSelect>
                </MudItem>

                 @if (_settings.RetentionMode == RetentionMode.SimpleDays)
                 {
                     <MudItem xs="12">
                         <MudNumericField @bind-Value="_settings.MaxDaysToKeep" Label="@L["Settings_Retention_Days"]" Min="1" Max="3650" />
                     </MudItem>
                 }
                 
                 @if (_settings.RetentionMode == RetentionMode.SimpleCount)
                 {
                     <MudItem xs="12">
                         <MudNumericField @bind-Value="_settings.MaxCountToKeep" Label="@L["Settings_Retention_Count"]" Min="1" Max="1000" />
                     </MudItem>
                 }

                @if (_settings.RetentionMode == RetentionMode.Smart)
                {
                     <MudItem xs="12">
                         <MudAlert Severity="Severity.Info">@L["Settings_Retention_Smart_Info"]</MudAlert>
                     </MudItem>
                }
            </MudGrid>
        </MudCollapse>
        
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveSettings">@L["Common_Save"]</MudButton>
    </MudPaper>
}

<MudText Class="mt-4">Current Backup Path: @(Environment.GetEnvironmentVariable("backup_path") ?? Path.Combine(Directory.GetCurrentDirectory(), "backups"))</MudText>

@code {
    private string _currentLanguage = "auto";
    private AppSettings? _settings;

    protected override async Task OnInitializedAsync()
    {
        var culture = CultureInfo.CurrentCulture.Name;
        if (culture.StartsWith("de")) _currentLanguage = "de";
        else if (culture.StartsWith("en")) _currentLanguage = "en";

        _settings = await Context.Settings.FindAsync(1);
        if (_settings == null)
        {
            // Fallback should not happen due to seeding
            _settings = new AppSettings { Id = 1 };
            Context.Settings.Add(_settings);
            await Context.SaveChangesAsync();
        }
    }

    private void ChangeLanguage(string language)
    {
        _currentLanguage = language;
        var uri = new Uri(NavigationManager.Uri)
            .GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);

        var culture = language == "auto" ? "" : $"?culture={language}";
        NavigationManager.NavigateTo($"api/Culture/Set?culture={language}&redirectUri={Uri.EscapeDataString(uri)}", true);
    }

    private async Task SaveSettings()
    {
        if (_settings != null)
        {
            Context.Settings.Update(_settings);
            await Context.SaveChangesAsync();
            Snackbar.Add(L["Settings_Saved_Success"], Severity.Success);
        }
    }
}
